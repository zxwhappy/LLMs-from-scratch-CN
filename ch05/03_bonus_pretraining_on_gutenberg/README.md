# **åœ¨ Project Gutenberg æ•°æ®é›†ä¸Šé¢„è®­ç»ƒ GPT**

æœ¬ç›®å½•åŒ…å«ç”¨äºåœ¨ **Project Gutenberg** æä¾›çš„å…è´¹ç”µå­ä¹¦ä¸Šè®­ç»ƒå°å‹ GPT æ¨¡å‹çš„ä»£ç ã€‚

æ ¹æ® **Project Gutenberg** ç½‘ç«™çš„è¯´æ˜ï¼Œâ€œç»å¤§å¤šæ•° Project Gutenberg ç”µå­ä¹¦åœ¨ç¾å›½å±äºå…¬æœ‰é¢†åŸŸã€‚â€  

åœ¨ä½¿ç”¨ Project Gutenberg æä¾›çš„èµ„æºä¹‹å‰ï¼Œè¯·é˜…è¯» [Project Gutenberg è®¸å¯ã€æƒé™å’Œå¸¸è§é—®é¢˜](https://www.gutenberg.org/policy/permission.html) äº†è§£è¯¦ç»†ä¿¡æ¯ã€‚
## ä½¿ç”¨æŒ‡å—

### 1) ä¸‹è½½æ•°æ®é›† 
åœ¨æœ¬èŠ‚ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨æ¥è‡ª [`pgcorpus/gutenberg`](https://github.com/pgcorpus/gutenberg) GitHub å­˜å‚¨åº“çš„ä»£ç ä»Project Gutenbergä¸‹è½½ä¹¦ç±ã€‚

æˆªè‡³æ’°å†™æœ¬æ–‡æ—¶ï¼Œè¿™å°†éœ€è¦å¤§çº¦ 50 GB çš„ç£ç›˜ç©ºé—´ï¼Œå¤§çº¦éœ€è¦ 10-15 ä¸ªå°æ—¶ï¼Œä½†å…·ä½“æ—¶é—´å¯èƒ½æ›´é•¿ï¼Œå…·ä½“å–å†³äºProject Gutenbergå½“å‰çš„å¤§å°ã€‚

#### Linux å’Œ macOS ç”¨æˆ·çš„ä¸‹è½½è¯´æ˜
Linux å’Œ macOS ç”¨æˆ·å¯ä»¥æŒ‰ç…§ä»¥ä¸‹æ­¥éª¤ä¸‹è½½æ•°æ®é›†ï¼ˆå¦‚æœæ‚¨æ˜¯ Windows ç”¨æˆ·ï¼Œè¯·å‚é˜…ä¸‹é¢çš„æ³¨é‡Šï¼‰ï¼š
1. å°† `03_bonus_pretraining_on_gutenberg` æ–‡ä»¶å¤¹è®¾ç½®ä¸ºå·¥ä½œç›®å½•ï¼Œä»¥åœ¨æ­¤æ–‡ä»¶å¤¹ä¸­æœ¬åœ°å…‹éš† `gutenberg` å­˜å‚¨åº“ï¼ˆè¿™æ˜¯è¿è¡Œæä¾›çš„è„šæœ¬ `prepare_dataset.py` å’Œ `pretraining_simple.py` æ‰€å¿…éœ€çš„ï¼‰ã€‚ä¾‹å¦‚ï¼Œå½“ä½äº `LLMs-from-scratch` å­˜å‚¨åº“çš„æ–‡ä»¶å¤¹ä¸­æ—¶ï¼Œé€šè¿‡ä»¥ä¸‹æ–¹å¼å¯¼èˆªåˆ° *03_bonus_pretraining_on_gutenberg* æ–‡ä»¶å¤¹ï¼š
```bash
cd ch05/03_bonus_pretraining_on_gutenberg
```

2. åœ¨è¯¥ç›®å½•ä¸­å…‹éš† `gutenberg` ä»“åº“ï¼š
```bash
git clone https://github.com/pgcorpus/gutenberg.git
```

3. è¿›å…¥æœ¬åœ°å…‹éš†çš„ `gutenberg` ä»“åº“ç›®å½•ï¼š
```bash
cd gutenberg
```

4. åœ¨ `gutenberg` ä»“åº“ç›®å½•ä¸­ï¼Œå®‰è£… *requirements.txt* æ–‡ä»¶ä¸­å®šä¹‰çš„åŒ…ï¼š
```bash
pip install -r requirements.txt
```

5. ä¸‹è½½æ•°æ®:
```bash
python get_data.py
```

6. å›åˆ°`03_bonus_pretraining_on_gutenberg` æ–‡ä»¶å§
```bash
cd ..
```

#### Windows ç”¨æˆ·çš„ç‰¹åˆ«è¯´æ˜  

[`pgcorpus/gutenberg`](https://github.com/pgcorpus/gutenberg) ä»£ç å…¼å®¹ Linux å’Œ macOSï¼Œä½† Windows ç”¨æˆ·éœ€è¦è¿›è¡Œä¸€äº›å°è°ƒæ•´ï¼Œä¾‹å¦‚åœ¨ `subprocess` è°ƒç”¨ä¸­æ·»åŠ  `shell=True`ï¼Œä»¥åŠæ›¿æ¢ `rsync` å‘½ä»¤ã€‚  

å¦ä¸€ç§æ›´ç®€å•çš„æ–¹æ³•æ˜¯åœ¨ Windows ä¸Šä½¿ç”¨ **Windows Subsystem for Linuxï¼ˆWSLï¼‰**ï¼Œè¯¥åŠŸèƒ½å…è®¸ç”¨æˆ·åœ¨ Windows ç¯å¢ƒä¸­è¿è¡ŒåŸºäº Ubuntu çš„ Linux ç³»ç»Ÿã€‚è¯¦ç»†ä¿¡æ¯è¯·å‚è€ƒ [Microsoft å®˜æ–¹å®‰è£…æŒ‡å—](https://learn.microsoft.com/en-us/windows/wsl/install) å’Œ [å®˜æ–¹æ•™ç¨‹](https://learn.microsoft.com/en-us/training/modules/wsl-introduction/)ã€‚  

ä½¿ç”¨ WSL æ—¶ï¼Œè¯·ç¡®ä¿å·²å®‰è£… Python 3ï¼ˆå¯é€šè¿‡ `python3 --version` æ£€æŸ¥ç‰ˆæœ¬ï¼Œè‹¥æœªå®‰è£…ï¼Œå¯ä½¿ç”¨ `sudo apt-get install -y python3.10` å®‰è£… Python 3.10ï¼‰ã€‚æ­¤å¤–ï¼Œè¿˜éœ€å®‰è£…ä»¥ä¸‹ä¾èµ–åŒ…ï¼š

```bash
sudo apt-get update && \
sudo apt-get upgrade -y && \
sudo apt-get install -y python3-pip && \
sudo apt-get install -y python-is-python3 && \
sudo apt-get install -y rsync
```

> **æ³¨æ„**  
> æœ‰å…³ Python ç¯å¢ƒé…ç½®å’Œä¾èµ–å®‰è£…çš„è¯¦ç»†è¯´æ˜ï¼Œè¯·å‚è€ƒï¼š[å¯é€‰ Python é…ç½®æŒ‡å—](../../setup/01_optional-python-setup-preferences/README.md) å’Œ [Python åº“å®‰è£…æŒ‡å—](../../setup/02_installing-python-libraries/README.md)ã€‚  
>   
> æ­¤å¤–ï¼Œæœ¬ä»“åº“æä¾›äº†ä¸€ä¸ªåŸºäº Ubuntu çš„ Docker é•œåƒã€‚å¦‚æœå¸Œæœ›ä½¿ç”¨å®¹å™¨åŒ–ç¯å¢ƒè¿è¡Œä»£ç ï¼Œè¯·å‚è€ƒ [å¯é€‰ Docker ç¯å¢ƒ](../../setup/03_optional-docker-environment/README.md) è·å–ç›¸å…³ä½¿ç”¨è¯´æ˜ã€‚  

&nbsp;  
### 2) å‡†å¤‡æ•°æ®é›†  

æ¥ä¸‹æ¥ï¼Œè¿è¡Œ `prepare_dataset.py` è„šæœ¬ï¼Œè¯¥è„šæœ¬ä¼šå°†ï¼ˆæˆªè‡³æ’°å†™æœ¬æ–‡æ—¶ï¼Œå…± 60,173 ä¸ªï¼‰æ–‡æœ¬æ–‡ä»¶åˆå¹¶ä¸ºæ›´å°‘æ•°é‡çš„å¤§æ–‡ä»¶ï¼Œä»¥æé«˜æ•°æ®ä¼ è¾“å’Œè®¿é—®æ•ˆç‡ï¼š

```bash
python prepare_dataset.py \
  --data_dir gutenberg/data/raw \
  --max_size_mb 500 \
  --output_dir gutenberg_preprocessed
```

```
...
Skipping gutenberg/data/raw/PG29836_raw.txt as it does not contain primarily English text.                                     Skipping gutenberg/data/raw/PG16527_raw.txt as it does not contain primarily English text.                                     100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 57250/57250 [25:04<00:00, 38.05it/s]
42 file(s) saved in /Users/sebastian/Developer/LLMs-from-scratch/ch05/03_bonus_pretraining_on_gutenberg/gutenberg_preprocessed
```


> **ğŸ’¡ æç¤º**  
> ç”Ÿæˆçš„æ–‡ä»¶å‡ä¸ºçº¯æ–‡æœ¬æ ¼å¼ï¼Œæœªè¿›è¡Œé¢„åˆ†è¯å¤„ç†ï¼Œä»¥ä¿æŒç®€æ´ã€‚ç„¶è€Œï¼Œå¦‚æœè®¡åˆ’é¢‘ç¹ä½¿ç”¨è¯¥æ•°æ®é›†æˆ–è¿›è¡Œå¤šè½®è®­ç»ƒï¼Œå»ºè®®ä¿®æ”¹ä»£ç ï¼Œå°†æ•°æ®å­˜å‚¨ä¸º **é¢„åˆ†è¯æ ¼å¼**ï¼Œä»¥å‡å°‘è®¡ç®—æˆæœ¬ã€‚æ›´å¤šä¿¡æ¯è¯·å‚è€ƒæœ¬é¡µåº•éƒ¨çš„ *è®¾è®¡å†³ç­–ä¸ä¼˜åŒ–å»ºè®®*ã€‚  

> **ğŸ’¡ æç¤º**  
> ä½ å¯ä»¥é€‰æ‹©æ›´å°çš„æ–‡ä»¶å¤§å°ï¼Œä¾‹å¦‚ **50MB**ã€‚è¿™æ ·ä¼šç”Ÿæˆæ›´å¤šæ–‡ä»¶ï¼Œä½†åœ¨æµ‹è¯•æ—¶ï¼Œå¯ç”¨äºå¿«é€Ÿé¢„è®­ç»ƒå°‘é‡æ•°æ®ï¼Œæé«˜è°ƒè¯•æ•ˆç‡ã€‚  

&nbsp;  
### 3) è¿è¡Œé¢„è®­ç»ƒè„šæœ¬  

å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤è¿è¡Œé¢„è®­ç»ƒè„šæœ¬ã€‚è¯·æ³¨æ„ï¼Œç¤ºä¾‹ä¸­åˆ—å‡ºçš„å‘½ä»¤è¡Œå‚æ•°å‡ä¸ºé»˜è®¤å€¼ï¼Œä»…ä½œè¯´æ˜ï¼š

```bash
python pretraining_simple.py \
  --data_dir "gutenberg_preprocessed" \
  --n_epochs 1 \
  --batch_size 4 \
  --output_dir model_checkpoints
```

è¾“å‡ºæ ¼å¼å¦‚ä¸‹æ‰€ç¤ºï¼š

> æ€»æ–‡ä»¶æ•°ï¼š3  
> æ­£åœ¨å¯¹æ–‡ä»¶ 1/3 è¿›è¡Œåˆ†è¯å¤„ç†ï¼šdata_small/combined_1.txt  
> è®­ç»ƒä¸­ ...  
> è½®æ¬¡ 1ï¼ˆæ­¥éª¤ 0ï¼‰ï¼šè®­ç»ƒæŸå¤± 9.694ï¼ŒéªŒè¯æŸå¤± 9.724  
> è½®æ¬¡ 1ï¼ˆæ­¥éª¤ 100ï¼‰ï¼šè®­ç»ƒæŸå¤± 6.672ï¼ŒéªŒè¯æŸå¤± 6.683  
> è½®æ¬¡ 1ï¼ˆæ­¥éª¤ 200ï¼‰ï¼šè®­ç»ƒæŸå¤± 6.543ï¼ŒéªŒè¯æŸå¤± 6.434  
> è½®æ¬¡ 1ï¼ˆæ­¥éª¤ 300ï¼‰ï¼šè®­ç»ƒæŸå¤± 5.772ï¼ŒéªŒè¯æŸå¤± 6.313  
> è½®æ¬¡ 1ï¼ˆæ­¥éª¤ 400ï¼‰ï¼šè®­ç»ƒæŸå¤± 5.547ï¼ŒéªŒè¯æŸå¤± 6.249  
> è½®æ¬¡ 1ï¼ˆæ­¥éª¤ 500ï¼‰ï¼šè®­ç»ƒæŸå¤± 6.182ï¼ŒéªŒè¯æŸå¤± 6.155  
> è½®æ¬¡ 1ï¼ˆæ­¥éª¤ 600ï¼‰ï¼šè®­ç»ƒæŸå¤± 5.742ï¼ŒéªŒè¯æŸå¤± 6.122  
> è½®æ¬¡ 1ï¼ˆæ­¥éª¤ 700ï¼‰ï¼šè®­ç»ƒæŸå¤± 6.309ï¼ŒéªŒè¯æŸå¤± 5.984  
> è½®æ¬¡ 1ï¼ˆæ­¥éª¤ 800ï¼‰ï¼šè®­ç»ƒæŸå¤± 5.435ï¼ŒéªŒè¯æŸå¤± 5.975  
> è½®æ¬¡ 1ï¼ˆæ­¥éª¤ 900ï¼‰ï¼šè®­ç»ƒæŸå¤± 5.582ï¼ŒéªŒè¯æŸå¤± 5.935  
> ...  
> è½®æ¬¡ 1ï¼ˆæ­¥éª¤ 31900ï¼‰ï¼šè®­ç»ƒæŸå¤± 3.664ï¼ŒéªŒè¯æŸå¤± 3.946  
> è½®æ¬¡ 1ï¼ˆæ­¥éª¤ 32000ï¼‰ï¼šè®­ç»ƒæŸå¤± 3.493ï¼ŒéªŒè¯æŸå¤± 3.939  
> è½®æ¬¡ 1ï¼ˆæ­¥éª¤ 32100ï¼‰ï¼šè®­ç»ƒæŸå¤± 3.940ï¼ŒéªŒè¯æŸå¤± 3.961  
> æ¨¡å‹å·²ä¿å­˜è‡³ model_checkpoints/model_pg_32188.pth  
> å¤„ç†ä¸€æœ¬ä¹¦è€—æ—¶ï¼š3 å°æ—¶ 46 åˆ† 55 ç§’  
> æ€»è®¡è€—æ—¶ï¼š3 å°æ—¶ 46 åˆ† 55 ç§’  
> é¢„è®¡å‰©ä½™æ—¶é—´ï¼š7 å°æ—¶ 33 åˆ† 50 ç§’  
> æ­£åœ¨å¯¹æ–‡ä»¶ 2/3 è¿›è¡Œåˆ†è¯å¤„ç†ï¼šdata_small/combined_2.txt  
> è®­ç»ƒä¸­ ...  
> è½®æ¬¡ 1ï¼ˆæ­¥éª¤ 32200ï¼‰ï¼šè®­ç»ƒæŸå¤± 2.982ï¼ŒéªŒè¯æŸå¤± 4.094  
> è½®æ¬¡ 1ï¼ˆæ­¥éª¤ 32300ï¼‰ï¼šè®­ç»ƒæŸå¤± 3.920ï¼ŒéªŒè¯æŸå¤± 4.097  
> ...


> **ğŸ’¡ æç¤º**  
> åœ¨ macOS æˆ– Linux ç³»ç»Ÿä¸Šï¼Œå»ºè®®ä½¿ç”¨ `tee` å‘½ä»¤å°†æ—¥å¿—è¾“å‡ºåŒæ—¶æ‰“å°åˆ°ç»ˆç«¯å¹¶ä¿å­˜è‡³ `log.txt` æ–‡ä»¶ï¼Œä»¥ä¾¿åç»­åˆ†æï¼š

```bash
python -u pretraining_simple.py | tee log.txt
```

> **âš ï¸ è­¦å‘Š**  
> åœ¨ **V100 GPU** ä¸Šï¼Œå¯¹ `gutenberg_preprocessed` ç›®å½•ä¸‹çš„ **1 ä¸ª ~500MB** æ–‡æœ¬æ–‡ä»¶è¿›è¡Œè®­ç»ƒå¤§çº¦éœ€è¦ **4 å°æ—¶**ã€‚  
> è¯¥æ–‡ä»¶å¤¹åŒ…å« **47 ä¸ªæ–‡ä»¶**ï¼Œå®Œæ•´è®­ç»ƒé¢„è®¡è€—æ—¶ **200 å°æ—¶ï¼ˆè¶…è¿‡ 1 å‘¨ï¼‰**ã€‚  
> å»ºè®®é€‰æ‹©è¾ƒå°‘çš„æ–‡ä»¶è¿›è¡Œè®­ç»ƒï¼Œä»¥å‡å°‘è®­ç»ƒæ—¶é—´ã€‚  

&nbsp;  
## è®¾è®¡å†³ç­–ä¸ä¼˜åŒ–å»ºè®®  

æœ¬ä»£ç ä»¥ **ç®€æ´æ€§å’Œå¯è¯»æ€§** ä¸ºä¸»ï¼Œæ—¨åœ¨ç”¨äº **æ•™è‚²ç›®çš„**ï¼Œä½†ä»æœ‰å¤šä¸ªæ–¹é¢å¯ä¼˜åŒ–ï¼Œä»¥æé«˜ **æ¨¡å‹æ€§èƒ½** å’Œ **è®­ç»ƒæ•ˆç‡**ï¼š  

1. **ä¼˜åŒ–æ•°æ®æ¸…ç†**ï¼šä¿®æ”¹ `prepare_dataset.py`ï¼Œå»é™¤æ¯æœ¬ä¹¦ä¸­çš„ **Gutenberg æ ‡å‡†é¡µçœ‰é¡µè„š**ï¼Œä»¥æå‡æ•°æ®è´¨é‡ã€‚  
2. **é¢„å¤„ç†åˆ†è¯**ï¼šè°ƒæ•´æ•°æ®å‡†å¤‡å’ŒåŠ è½½æµç¨‹ï¼Œå°†æ•°æ®é›†**é¢„åˆ†è¯å¹¶å­˜å‚¨ä¸ºåˆ†è¯æ ¼å¼**ï¼Œé¿å…æ¯æ¬¡è°ƒç”¨é¢„è®­ç»ƒè„šæœ¬æ—¶éƒ½é‡æ–°åˆ†è¯ï¼Œå‡å°‘è®¡ç®—å¼€é”€ã€‚  
3. **æ”¹è¿›è®­ç»ƒè¿‡ç¨‹**ï¼šåœ¨ `train_model_simple` ä¸­ï¼Œæ·»åŠ  [é™„å½• D: è®­ç»ƒä¼˜åŒ–æŠ€å·§](../../appendix-D/01_main-chapter-code/appendix-D.ipynb) ä¸­ä»‹ç»çš„ä¼˜åŒ–åŠŸèƒ½ï¼Œå¦‚ï¼š
   - **ä½™å¼¦è¡°å‡è°ƒåº¦ï¼ˆCosine Decayï¼‰**  
   - **çº¿æ€§é¢„çƒ­ï¼ˆLinear Warmupï¼‰**  
   - **æ¢¯åº¦è£å‰ªï¼ˆGradient Clippingï¼‰**  
4. **æ”¯æŒæ–­ç‚¹æ¢å¤**ï¼šä¿®æ”¹é¢„è®­ç»ƒè„šæœ¬ï¼Œä½¿å…¶åœ¨ä¿å­˜ **æ¨¡å‹æƒé‡** çš„åŒæ—¶ä¿å­˜ **ä¼˜åŒ–å™¨çŠ¶æ€**ï¼ˆå‚è€ƒç¬¬ 5 ç«  *5.4 PyTorch çš„æƒé‡åŠ è½½ä¸ä¿å­˜*ï¼Œ[ch05.ipynb](../../ch05/01_main-chapter-code/ch05.ipynb)ï¼‰ï¼Œå¹¶æ”¯æŒ**æ–­ç‚¹ç»­è®­**ã€‚  
5. **æ·»åŠ å¯è§†åŒ–æ—¥å¿—**ï¼šé›†æˆ **Weights & Biases** æˆ–å…¶ä»–æ—¥å¿—å·¥å…·ï¼Œä»¥å®æ—¶æŸ¥çœ‹è®­ç»ƒæŸå¤±å’ŒéªŒè¯æ›²çº¿ã€‚  
6. **å¤š GPU å¹¶è¡Œè®­ç»ƒ**ï¼šå®ç° **åˆ†å¸ƒå¼æ•°æ®å¹¶è¡Œï¼ˆDDPï¼‰**ï¼Œåœ¨å¤šä¸ª GPU è®¾å¤‡ä¸ŠåŠ é€Ÿè®­ç»ƒï¼ˆå‚è€ƒé™„å½• A *A.9.3 å¤š GPU è®­ç»ƒ*ï¼Œ[DDP-script.py](../../appendix-A/01_main-chapter-code/DDP-script.py)ï¼‰ã€‚  
7. **ä¼˜åŒ–æ³¨æ„åŠ›æœºåˆ¶**ï¼šæ›¿æ¢ `previous_chapter.py` ä¸­çš„ `MultiheadAttention` ç±»ï¼Œä½¿ç”¨ [é«˜æ•ˆå¤šå¤´æ³¨æ„åŠ›å®ç°](../../ch03/02_bonus_efficient-multihead-attention/mha-implementations.ipynb) ç« èŠ‚ä¸­çš„ `MHAPyTorchScaledDotProduct`ï¼Œè¯¥å®ç°åŸºäº PyTorch **Flash Attention**ï¼ˆ`nn.functional.scaled_dot_product_attention`ï¼‰ï¼Œå¯å¤§å¹…æå‡è®¡ç®—æ•ˆç‡ã€‚  
8. **åŠ é€Ÿè®­ç»ƒ**ï¼šé‡‡ç”¨ **æ¨¡å‹ç¼–è¯‘ä¼˜åŒ–**ï¼Œå¯é€‰æ‹©ï¼š
   - **PyTorch 2.0 çš„ `torch.compile`**ï¼ˆ[`torch.compile` æ•™ç¨‹](https://pytorch.org/tutorials/intermediate/torch_compile_tutorial.html)ï¼‰  
   - **Lightning Thunder çš„ `thunder.jit(model)`**ï¼ˆ[Thunder GitHub](https://github.com/Lightning-AI/lightning-thunder)ï¼‰  
9. **ä½ç§©æ¢¯åº¦æŠ•å½±ï¼ˆGaLoreï¼‰ä¼˜åŒ–**ï¼šé€šè¿‡ **Gradient Low-Rank Projectionï¼ˆGaLoreï¼‰** åŠ é€Ÿé¢„è®­ç»ƒï¼Œä»…éœ€å°†ä¼˜åŒ–å™¨ **`AdamW` æ›¿æ¢ä¸º `GaLoreAdamW`**ï¼Œè¯¥ä¼˜åŒ–å™¨å·²é›†æˆåœ¨ [GaLore Python åº“](https://github.com/jiaweizzhao/GaLore) ä¸­ã€‚